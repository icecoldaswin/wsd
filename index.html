<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sequence Diagram Studio</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --primary-dark: #5a67d8;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --bg-primary: #0f0f23;
            --bg-secondary: #1e1e3e;
            --bg-tertiary: #2a2a4a;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #334155;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --editor-bg: #1a1a2e;
            --shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.4);
            
            /* SVG Theme Colors */
            --svg-bg: #1a1a2e;
            --svg-participant-bg: #2a2a4a;
            --svg-participant-border: var(--primary-color);
            --svg-text: var(--text-primary);
            --svg-lifeline: #4a5568;
            --svg-message: var(--text-primary);
            --svg-note-bg: #2d3748;
            --svg-note-border: var(--warning-color);
            --svg-activation-bg: #4a5568;
            --svg-activation-border: var(--primary-color);
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e2e8f0;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --border-color: #e2e8f0;
            --editor-bg: #ffffff;
            
            /* Light SVG Theme Colors */
            --svg-bg: #ffffff;
            --svg-participant-bg: #f7fafc;
            --svg-participant-border: var(--primary-color);
            --svg-text: #1a202c;
            --svg-lifeline: #cbd5e1;
            --svg-message: #374151;
            --svg-note-bg: #fef5e7;
            --svg-note-border: var(--warning-color);
            --svg-activation-bg: #fef3c7;
            --svg-activation-border: var(--warning-color);
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .app-container {
            display: grid;
            grid-template-columns: 400px 1fr;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 1px;
            background: var(--border-color);
        }

        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1), transparent);
            pointer-events: none;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(45deg, var(--accent-color), white);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .logo-icon::before {
            content: '‚ö°';
            font-size: 18px;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .editor-panel {
            background: var(--editor-bg);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow);
            position: relative;
            transition: all 0.3s ease;
        }

        .panel-header {
            background: var(--bg-tertiary);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title::before {
            content: 'üìù';
            font-size: 16px;
        }

        .version-control {
            font-size: 12px;
            color: var(--text-muted);
            cursor: pointer;
            text-decoration: underline;
        }

        .version-control:hover {
            color: var(--primary-color);
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .code-editor {
            flex: 1;
            border: none;
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            background: var(--editor-bg);
            color: var(--text-primary);
            resize: none;
            outline: none;
            caret-color: var(--primary-color);
            transition: all 0.3s ease;
        }

        .code-editor::placeholder {
            color: var(--text-muted);
        }

        .code-editor:focus {
            background: var(--bg-primary);
        }

        .syntax-help {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 16px 20px;
            font-size: 11px;
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--bg-tertiary);
        }

        .syntax-help::-webkit-scrollbar {
            width: 6px;
        }

        .syntax-help::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        .syntax-help::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 3px;
        }

        .help-section {
            margin-bottom: 16px;
        }

        .help-title {
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .help-example {
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg-primary);
            color: var(--success-color);
            padding: 6px 10px;
            border-radius: 6px;
            margin: 4px 0;
            display: block;
            border-left: 3px solid var(--primary-color);
            font-size: 11px;
        }

        .diagram-panel {
            background: var(--bg-secondary);
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .diagram-header {
            background: var(--bg-tertiary);
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .diagram-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .diagram-title::before {
            content: 'üé®';
            font-size: 16px;
        }

        .diagram-container {
            flex: 1;
            padding: 24px;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            background: radial-gradient(circle at 50% 50%, rgba(102, 126, 234, 0.05), transparent 70%);
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--bg-tertiary);
        }

        .diagram-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .diagram-container::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        .diagram-container::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        #diagram-svg {
            background: var(--svg-bg);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        #diagram-svg:hover {
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        /* SVG Styling with theme support */
        .participant-box {
            fill: var(--svg-participant-bg);
            stroke: var(--svg-participant-border);
            stroke-width: 2;
            rx: 10;
            ry: 10;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .participant-text {
            font-family: 'Inter', sans-serif;
            font-size: 12px;
            font-weight: 600;
            text-anchor: middle;
            fill: var(--svg-text);
        }

        .lifeline {
            stroke: var(--svg-lifeline);
            stroke-width: 2;
            stroke-dasharray: 8,4;
            opacity: 0.7;
        }

        .activation {
            fill: var(--svg-activation-bg);
            stroke: var(--svg-activation-border);
            stroke-width: 2;
            rx: 2;
            ry: 2;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .message-line {
            stroke: var(--svg-message);
            stroke-width: 2.5;
            fill: none;
        }

        .message-dashed {
            stroke-dasharray: 10,5;
            opacity: 0.8;
        }

        .message-return {
            stroke: var(--svg-message);
            opacity: 0.8;
        }

        .message-text {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 500;
            text-anchor: middle;
            fill: var(--svg-text);
        }

        .message-bg {
            fill: var(--svg-bg);
            stroke: var(--border-color);
            stroke-width: 1;
            opacity: 0.9;
        }

        .note {
            fill: var(--svg-note-bg);
            stroke: var(--svg-note-border);
            stroke-width: 2;
            rx: 8;
            ry: 8;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
        }

        .note-text {
            font-family: 'Inter', sans-serif;
            font-size: 10px;
            font-weight: 500;
            fill: var(--svg-text);
        }

        .loop-box, .alt-box {
            fill: none;
            stroke: var(--svg-message);
            stroke-width: 2;
            rx: 8;
            ry: 8;
            stroke-dasharray: 5,5;
            opacity: 0.6;
        }

        .loop-label, .alt-label {
            fill: var(--svg-participant-bg);
            stroke: var(--svg-message);
            stroke-width: 2;
            rx: 6;
            ry: 6;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        }

        .alt-label {
            fill: var(--svg-note-bg);
            stroke: var(--error-color);
        }

        .loop-text, .alt-text {
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            font-weight: 600;
            fill: var(--svg-text);
        }

        .title-text {
            font-family: 'Inter', sans-serif;
            font-size: 18px;
            font-weight: 700;
            text-anchor: middle;
            fill: var(--svg-text);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 30px;
            border-radius: 16px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .close {
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s ease;
        }

        .close:hover {
            color: var(--text-primary);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .theme-toggle {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 25px;
            padding: 4px;
            position: relative;
        }

        .theme-option {
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
        }

        .theme-option.active {
            background: var(--primary-color);
            color: white;
        }

        .theme-option:not(.active) {
            color: var(--text-muted);
        }

        .export-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 20px;
        }

        .export-btn {
            padding: 12px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .export-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-top: 16px;
        }

        .file-item {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .file-item:hover {
            background: var(--bg-tertiary);
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .file-meta {
            font-size: 12px;
            color: var(--text-muted);
        }

        .version-list {
            margin-left: 20px;
            margin-top: 8px;
        }

        .version-item {
            padding: 6px 12px;
            font-size: 12px;
            color: var(--text-secondary);
            cursor: pointer;
            border-radius: 4px;
            margin-bottom: 4px;
        }

        .version-item:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .current-version {
            background: var(--primary-color);
            color: white;
        }

        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .input-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 14px;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .delete-btn {
            background: var(--error-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            background: #dc2626;
            transform: scale(1.1);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 350px 1fr;
            }
            
            .syntax-help {
                max-height: 150px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: 60px auto 1fr;
            }
            
            .editor-panel {
                height: 300px;
            }
            
            .syntax-help {
                display: none;
            }
        }

        /* Dark scrollbars for webkit browsers */
        * {
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--bg-tertiary);
        }

        *::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        *::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
        }

        *::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        *::-webkit-scrollbar-thumb:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body data-theme="dark">
    <div class="app-container">
        <header class="header">
            <div class="logo">
                <div class="logo-icon"></div>
                Sequence Diagram Studio
            </div>
            <div class="header-actions">
                <button class="btn btn-secondary" id="importBtn">
                    üìÅ Import
                </button>
                <button class="btn btn-secondary" id="exportBtn">
                    üì§ Export
                </button>
                <button class="btn btn-secondary" id="openBtn">
                    üìÇ Open
                </button>
                <button class="btn btn-secondary" id="saveBtn">
                    üíæ Save
                </button>
                <button class="btn btn-secondary" id="themeToggle">
                    üåô Dark
                </button>
            </div>
        </header>

        <div class="editor-panel">
            <div class="panel-header">
                <div class="panel-title">Code Editor</div>
                <div class="version-control" id="versionControl" style="display: none;">version: 1</div>
            </div>
            <div class="editor-container">
                <textarea class="code-editor" id="codeEditor" placeholder="‚ú® Start creating your sequence diagram...">title: User Authentication Flow

participant User
participant Frontend
participant AuthService
participant Database
participant EmailService

User->Frontend: Enter login credentials
activate Frontend

Frontend->AuthService: POST /auth/login
activate AuthService

AuthService->Database: Validate user credentials
activate Database
Database-->AuthService: User data
deactivate Database

alt Valid credentials
    AuthService->AuthService: Generate JWT token
    AuthService-->Frontend: 200 OK + JWT token
    deactivate AuthService
    
    Frontend->Frontend: Store token
    Frontend-->User: Redirect to dashboard
    deactivate Frontend
    
else Invalid credentials
    AuthService-->Frontend: 401 Unauthorized
    deactivate AuthService
    
    Frontend-->User: Show error message
    deactivate Frontend
    
    note over User,Frontend: User can retry login
    
    loop Max 3 attempts
        User->Frontend: Retry login
        Frontend->AuthService: POST /auth/login
        activate AuthService
        
        AuthService->Database: Check attempts
        activate Database
        
        alt Too many attempts
            Database-->AuthService: Account locked
            deactivate Database
            
            AuthService->EmailService: Send unlock email
            activate EmailService
            EmailService-->AuthService: Email sent
            deactivate EmailService
            
            AuthService-->Frontend: 429 Too Many Requests
            deactivate AuthService
        end
    end
end

note over AuthService,EmailService: Security measures in place</textarea>
                <div class="syntax-help">
                    <div class="help-section">
                        <div class="help-title">Basic Syntax</div>
                        <code class="help-example">title: Your Diagram Title</code>
                        <code class="help-example">participant Alice</code>
                        <code class="help-example">Alice->Bob: Solid arrow message</code>
                        <code class="help-example">Bob-->Alice: Dashed return message</code>
                    </div>
                    <div class="help-section">
                        <div class="help-title">Lifeline Control</div>
                        <code class="help-example">activate Alice</code>
                        <code class="help-example">deactivate Alice</code>
                    </div>
                    <div class="help-section">
                        <div class="help-title">Notes & Labels</div>
                        <code class="help-example">note over Alice,Bob: Spanning note</code>
                        <code class="help-example">note left of Alice: Left side note</code>
                        <code class="help-example">note right of Bob: Right side note</code>
                    </div>
                    <div class="help-section">
                        <div class="help-title">Control Structures</div>
                        <code class="help-example">loop condition<br>&nbsp;&nbsp;Alice->Bob: Repeated action<br>end</code>
                        <code class="help-example">alt success case<br>&nbsp;&nbsp;Alice->Bob: Success path<br>else failure case<br>&nbsp;&nbsp;Alice->Bob: Error path<br>end</code>
                    </div>
                </div>
            </div>
        </div>

        <div class="diagram-panel">
            <div class="diagram-header">
                <div class="diagram-title">Generated Diagram</div>
            </div>
            <div class="diagram-container">
                <svg id="diagram-svg" width="800" height="600">
                    <defs>
                        <marker id="arrowhead" markerWidth="8" markerHeight="6" 
                         refX="7" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="var(--svg-message)" />
                        </marker>
                        <marker id="arrowhead-dashed" markerWidth="8" markerHeight="6" 
                         refX="7" refY="3" orient="auto">
                            <polygon points="0 0, 8 3, 0 6" fill="var(--svg-message)" opacity="0.8" />
                        </marker>
                    </defs>
                </svg>
            </div>
        </div>
    </div>



    <!-- Open Modal -->
    <div id="openModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Open Diagram</h2>
                <span class="close" id="closeOpen">&times;</span>
            </div>
            <div class="file-list" id="fileList">
                <!-- Files will be populated here -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div id="exportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Export Diagram</h2>
                <span class="close" id="closeExport">&times;</span>
            </div>
            <div class="export-options">
                <button class="export-btn" onclick="exportAs('png')">üì∑ PNG</button>
                <button class="export-btn" onclick="exportAs('svg')">üé® SVG</button>
                <button class="export-btn" onclick="exportAs('pdf')">üìÑ PDF</button>
                <button class="export-btn" onclick="copyToClipboard()">üìã Copy</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const DiagramConfig = {
            participantWidth: 130,
            participantHeight: 45,
            participantSpacing: 160,
            messageSpacing: 55,
            startY: 90,
            participantY: 45,
            noteWidth: 120,
            noteHeight: 70,
            activationWidth: 14,
            margin: 60,
            colors: {
                primary: '#667eea',
                secondary: '#6b7280',
                text: '#1f2937'
            }
        };

        // Theme Management
        class ThemeManager {
            constructor() {
                this.currentTheme = localStorage.getItem('theme') || 'dark';
                this.init();
            }

            init() {
                this.applyTheme(this.currentTheme);
                this.setupEventListeners();
            }

            setupEventListeners() {
                const themeToggle = document.getElementById('themeToggle');
                themeToggle.addEventListener('click', () => this.toggleTheme());
            }

            toggleTheme() {
                const newTheme = this.currentTheme === 'dark' ? 'light' : 'dark';
                this.applyTheme(newTheme);
            }

            applyTheme(theme) {
                this.currentTheme = theme;
                document.body.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);

                // Update toggle button
                const themeToggle = document.getElementById('themeToggle');
                themeToggle.innerHTML = theme === 'dark' ? 'üåô Dark' : '‚òÄÔ∏è Light';

                // Theme options removed

                // Re-render diagram to update colors
                if (window.diagramEditor) {
                    window.diagramEditor.updateDiagram();
                }
            }
        }

        // Storage Manager
        class StorageManager {
            constructor() {
                this.storageKey = 'wsd_diagrams';
            }

            saveFile(name, content) {
                const files = this.getFiles();
                let finalName = name;
                
                if (files[finalName]) {
                    // File exists, add new version
                    files[finalName].versions.push({ content, timestamp: Date.now() });
                    files[finalName].currentVersion = files[finalName].versions.length - 1;
                } else {
                    // Check for sequence numbered files
                    let counter = 1;
                    while (files[`${name}_${counter}`]) {
                        counter++;
                    }
                    if (counter > 1) {
                        finalName = `${name}_${counter}`;
                    }
                    
                    // Create new file
                    files[finalName] = { versions: [], currentVersion: 0 };
                    files[finalName].versions.push({ content, timestamp: Date.now() });
                    files[finalName].currentVersion = files[finalName].versions.length - 1;
                }
                
                localStorage.setItem(this.storageKey, JSON.stringify(files));
                return { name: finalName, version: files[finalName].versions.length };
            }

            generateFileName(parseData) {
                if (parseData.title) {
                    return parseData.title.replace(/\s+/g, '-').toLowerCase();
                }
                if (parseData.participants.length > 0) {
                    return 'untitled-' + parseData.participants.join('-').toLowerCase();
                }
                return 'untitled';
            }

            getFiles() {
                return JSON.parse(localStorage.getItem(this.storageKey) || '{}');
            }

            loadFile(name, version = null) {
                const files = this.getFiles();
                if (!files[name]) return null;
                const versionIndex = version !== null ? version : files[name].currentVersion;
                return files[name].versions[versionIndex];
            }

            getFileVersions(name) {
                const files = this.getFiles();
                return files[name] ? files[name].versions : [];
            }
        }

        // Modal Management
        class ModalManager {
            constructor() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Export modal
                document.getElementById('exportBtn').addEventListener('click', () => {
                    document.getElementById('exportModal').style.display = 'block';
                });
                
                document.getElementById('closeExport').addEventListener('click', () => {
                    document.getElementById('exportModal').style.display = 'none';
                });

                // Save button
                document.getElementById('saveBtn').addEventListener('click', () => {
                    window.diagramEditor.saveCurrentDiagram();
                });

                // Open modal
                document.getElementById('openBtn').addEventListener('click', () => {
                    this.populateFileList();
                    document.getElementById('openModal').style.display = 'block';
                });
                
                document.getElementById('closeOpen').addEventListener('click', () => {
                    document.getElementById('openModal').style.display = 'none';
                });

                // Import button
                document.getElementById('importBtn').addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.txt,.wsd';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            const reader = new FileReader();
                            reader.onload = (e) => {
                                document.getElementById('codeEditor').value = e.target.result;
                                window.diagramEditor.updateDiagram();
                            };
                            reader.readAsText(file);
                        }
                    };
                    input.click();
                });

                // Close modals when clicking outside
                window.addEventListener('click', (event) => {
                    if (event.target.classList.contains('modal')) {
                        event.target.style.display = 'none';
                    }
                });
            }

            populateFileList() {
                const fileList = document.getElementById('fileList');
                const files = window.storageManager.getFiles();
                fileList.innerHTML = '';

                if (Object.keys(files).length === 0) {
                    fileList.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No saved files</div>';
                    return;
                }

                Object.entries(files).forEach(([name, data]) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    const lastVersion = data.versions[data.versions.length - 1];
                    fileItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div class="file-name">${name}</div>
                                <div class="file-meta">${data.versions.length} version(s) ‚Ä¢ Last modified: ${new Date(lastVersion.timestamp).toLocaleDateString()}</div>
                            </div>
                            <button class="delete-btn" onclick="event.stopPropagation(); window.modalManager.deleteFile('${name}')">üóëÔ∏è</button>
                        </div>
                        <div class="version-list" id="versions-${name}" style="display: none;"></div>
                    `;
                    
                    fileItem.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const versionList = document.getElementById(`versions-${name}`);
                        if (versionList.style.display === 'none') {
                            versionList.style.display = 'block';
                            this.populateVersionList(name, versionList);
                        } else {
                            versionList.style.display = 'none';
                        }
                    });
                    
                    fileList.appendChild(fileItem);
                });
            }

            populateVersionList(fileName, container) {
                const versions = window.storageManager.getFileVersions(fileName);
                container.innerHTML = '';
                
                versions.forEach((version, index) => {
                    const versionItem = document.createElement('div');
                    versionItem.className = 'version-item';
                    versionItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>Version ${index + 1} - ${new Date(version.timestamp).toLocaleString()}</div>
                            <button class="delete-btn" onclick="event.stopPropagation(); window.modalManager.deleteVersion('${fileName}', ${index})">üóëÔ∏è</button>
                        </div>
                    `;
                    versionItem.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('delete-btn')) {
                            e.stopPropagation();
                            this.loadFileVersion(fileName, index);
                        }
                    });
                    container.appendChild(versionItem);
                });
            }

            loadFileVersion(fileName, version) {
                const fileData = window.storageManager.loadFile(fileName, version);
                if (fileData) {
                    document.getElementById('codeEditor').value = fileData.content;
                    window.diagramEditor.updateDiagram();
                    window.diagramEditor.setCurrentFile(fileName, version + 1);
                    document.getElementById('openModal').style.display = 'none';
                }
            }

            showVersionModal(fileName) {
                const fileList = document.getElementById('fileList');
                const versions = window.storageManager.getFileVersions(fileName);
                fileList.innerHTML = '';

                const backBtn = document.createElement('div');
                backBtn.innerHTML = '‚Üê Back to files';
                backBtn.style.cssText = 'padding: 12px; cursor: pointer; color: var(--primary-color); border-bottom: 1px solid var(--border-color);';
                backBtn.addEventListener('click', () => this.populateFileList());
                fileList.appendChild(backBtn);

                versions.forEach((version, index) => {
                    const versionItem = document.createElement('div');
                    versionItem.className = 'file-item';
                    versionItem.innerHTML = `
                        <div class="file-name">Version ${index + 1}</div>
                        <div class="file-meta">${new Date(version.timestamp).toLocaleString()}</div>
                    `;
                    versionItem.addEventListener('click', () => {
                        this.loadFileVersion(fileName, index);
                    });
                    fileList.appendChild(versionItem);
                });

                document.getElementById('openModal').style.display = 'block';
            }

            deleteFile(fileName) {
                if (confirm(`Delete file "${fileName}" and all its versions?`)) {
                    const files = window.storageManager.getFiles();
                    delete files[fileName];
                    localStorage.setItem(window.storageManager.storageKey, JSON.stringify(files));
                    this.populateFileList();
                }
            }

            deleteVersion(fileName, versionIndex) {
                const files = window.storageManager.getFiles();
                if (files[fileName] && files[fileName].versions.length > 1) {
                    if (confirm(`Delete version ${versionIndex + 1}?`)) {
                        files[fileName].versions.splice(versionIndex, 1);
                        if (files[fileName].currentVersion >= versionIndex) {
                            files[fileName].currentVersion = Math.max(0, files[fileName].currentVersion - 1);
                        }
                        localStorage.setItem(window.storageManager.storageKey, JSON.stringify(files));
                        this.showVersionModal(fileName);
                    }
                } else {
                    alert('Cannot delete the only version. Delete the entire file instead.');
                }
            }
        }

        // Parser Class
        class DiagramParser {
            constructor() {
                this.reset();
            }

            parse(text) {
                this.reset();
                const lines = text.split('\n').map(line => line.trim()).filter(line => line);
                
                let loopStack = [];
                let altStack = [];
                
                for (let line of lines) {
                    this.parseLine(line, loopStack, altStack);
                }

                return this.getParseResult();
            }

            parseLine(line, loopStack, altStack) {
                if (line.startsWith('title:')) {
                    this.title = line.substring(6).trim();
                } else if (line.startsWith('participant ')) {
                    const participantDef = line.substring(11).trim();
                    let name, alias;
                    
                    if (participantDef.includes(' as ')) {
                        const parts = participantDef.split(' as ');
                        name = parts[0].trim();
                        alias = parts[1].trim().replace(/"/g, '');
                        this.participantAliases.set(name, alias);
                    } else {
                        name = participantDef;
                        alias = name;
                    }
                    
                    if (!this.participants.includes(name)) {
                        this.participants.push(name);
                    }
                } else if (line.includes('->') || line.includes('-->')) {
                    this.parseMessage(line);
                } else if (line.startsWith('activate ')) {
                    this.parseActivation(line, 'activate');
                } else if (line.startsWith('deactivate ')) {
                    this.parseActivation(line, 'deactivate');
                } else if (line.startsWith('note ')) {
                    this.parseNote(line);
                } else if (line.startsWith('loop ')) {
                    const condition = line.substring(5).trim();
                    loopStack.push({ type: 'loop', condition, startIndex: this.messages.length });
                } else if (line.startsWith('alt ')) {
                    const condition = line.substring(4).trim();
                    altStack.push({ type: 'alt', condition, startIndex: this.messages.length, branches: [condition] });
                } else if (line.startsWith('else') && altStack.length > 0) {
                    const currentAlt = altStack[altStack.length - 1];
                    if (!currentAlt.elseIndexes) {
                        currentAlt.elseIndexes = [];
                    }
                    const elseCondition = line.substring(4).trim() || '';
                    currentAlt.elseIndexes.push({ index: this.messages.length, condition: elseCondition });
                    currentAlt.branches.push('else');
                } else if (line === 'end') {
                    if (loopStack.length > 0) {
                        const loop = loopStack.pop();
                        loop.endIndex = this.messages.length - 1;
                        this.loops.push(loop);
                    } else if (altStack.length > 0) {
                        const alt = altStack.pop();
                        alt.endIndex = this.messages.length - 1;
                        this.alts.push(alt);
                    }
                }
            }

            parseMessage(line) {
                let isDashed = line.includes('-->');
                let parts = isDashed ? line.split('-->') : line.split('->');
                
                if (parts.length === 2) {
                    let from = parts[0].trim();
                    let [to, message] = parts[1].split(':').map(s => s.trim());
                    
                    this.addParticipantIfNotExists(from);
                    this.addParticipantIfNotExists(to);
                    
                    this.messages.push({ from, to, message: message || '', isDashed });
                }
            }

            parseActivation(line, type) {
                const participant = line.substring(type === 'activate' ? 9 : 11).trim();
                if (!this.activations.has(participant)) {
                    this.activations.set(participant, []);
                }
                this.activations.get(participant).push({ type, messageIndex: this.messages.length });
            }

            parseNote(line) {
                const parts = line.split(':');
                const noteText = parts[1] ? parts[1].trim() : '';
                const noteDef = parts[0].trim();
                
                if (noteDef.includes('over ')) {
                    const participants = noteDef.substring(noteDef.indexOf('over ') + 5).split(',').map(p => p.trim());
                    this.notes.push({ 
                        type: 'over', 
                        participants, 
                        text: noteText, 
                        messageIndex: this.messages.length 
                    });
                } else if (noteDef.includes('left of ')) {
                    const participant = noteDef.substring(noteDef.indexOf('left of ') + 8).trim();
                    this.notes.push({ 
                        type: 'left', 
                        participant, 
                        text: noteText, 
                        messageIndex: this.messages.length 
                    });
                } else if (noteDef.includes('right of ')) {
                    const participant = noteDef.substring(noteDef.indexOf('right of ') + 9).trim();
                    this.notes.push({ 
                        type: 'right', 
                        participant, 
                        text: noteText, 
                        messageIndex: this.messages.length 
                    });
                }
            }

            addParticipantIfNotExists(participant) {
                if (!this.participants.includes(participant)) {
                    this.participants.push(participant);
                }
            }

            reset() {
                this.participants = [];
                this.messages = [];
                this.notes = [];
                this.activations = new Map();
                this.loops = [];
                this.alts = [];
                this.title = '';
                this.participantAliases = new Map();
            }

            getParseResult() {
                return {
                    participants: this.participants,
                    messages: this.messages,
                    notes: this.notes,
                    activations: this.activations,
                    loops: this.loops,
                    alts: this.alts,
                    title: this.title,
                    participantAliases: this.participantAliases
                };
            }
        }

        // Renderer Class
        class DiagramRenderer {
            constructor(svgElement) {
                this.svg = svgElement;
                this.config = DiagramConfig;
            }

            render(parseData) {
                const defs = this.svg.querySelector('defs');
                this.svg.innerHTML = '';
                this.svg.appendChild(defs);
                
                if (parseData.participants.length === 0) return;

                let currentY = this.config.startY;
                
                if (parseData.title) {
                    this.renderTitle(parseData.title);
                    currentY += 50;
                }

                const participantPositions = this.calculateParticipantPositions(parseData.participants);
                this.renderParticipants(participantPositions, currentY, parseData);
                currentY += this.config.participantHeight + 35;

                let totalHeight = currentY + parseData.messages.length * this.config.messageSpacing + 120;
                this.renderLifelines(participantPositions, currentY, totalHeight);
                
                // Pre-render loop and alt boxes
                this.renderControlStructureBoxes(parseData, participantPositions, currentY);
                
                currentY = this.renderMessagesAndElements(parseData, participantPositions, currentY);
                this.updateSVGDimensions(parseData.participants.length, currentY);
            }

            calculateParticipantPositions(participants) {
                const positions = new Map();
                participants.forEach((participant, index) => {
                    const x = this.config.margin + index * this.config.participantSpacing + this.config.participantWidth / 2;
                    positions.set(participant, x);
                });
                return positions;
            }

            renderTitle(title) {
                const titleElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                titleElement.setAttribute('x', 400);
                titleElement.setAttribute('y', 35);
                titleElement.setAttribute('class', 'title-text');
                titleElement.textContent = title;
                this.svg.appendChild(titleElement);
            }

            renderParticipants(positions, y, parseData) {
                positions.forEach((x, participant) => {
                    const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                    rect.setAttribute('x', x - this.config.participantWidth / 2);
                    rect.setAttribute('y', y);
                    rect.setAttribute('width', this.config.participantWidth);
                    rect.setAttribute('height', this.config.participantHeight);
                    rect.setAttribute('class', 'participant-box');
                    this.svg.appendChild(rect);

                    const displayName = parseData.participantAliases.get(participant) || participant;
                    const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    text.setAttribute('x', x);
                    text.setAttribute('y', y + this.config.participantHeight / 2 + 5);
                    text.setAttribute('class', 'participant-text');
                    text.textContent = displayName;
                    this.svg.appendChild(text);
                });
            }

            renderLifelines(positions, startY, endY) {
                positions.forEach((x, participant) => {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', x);
                    line.setAttribute('y1', startY + this.config.participantHeight);
                    line.setAttribute('x2', x);
                    line.setAttribute('y2', endY);
                    line.setAttribute('class', 'lifeline');
                    this.svg.appendChild(line);
                });
            }

            renderControlStructureBoxes(parseData, positions, startY) {
                // Calculate message positions first
                const messagePositions = new Map();
                let currentY = startY;
                
                for (let i = 0; i < parseData.messages.length; i++) {
                    // Account for notes
                    const notesAtThisIndex = parseData.notes.filter(note => note.messageIndex === i);
                    for (const note of notesAtThisIndex) {
                        currentY += 25 + this.config.noteHeight + 25;
                    }

                    // Account for loop/alt starts
                    const loopAtThisIndex = parseData.loops.find(loop => loop.startIndex === i);
                    const altAtThisIndex = parseData.alts.find(alt => alt.startIndex === i);
                    
                    if (loopAtThisIndex || altAtThisIndex) {
                        currentY += 70;
                    }

                    messagePositions.set(i, currentY);
                    currentY += this.config.messageSpacing;

                    // Account for alt else
                    const altWithElse = parseData.alts.find(alt => 
                        alt.elseIndexes && alt.elseIndexes.some(elseData => elseData.index === i)
                    );
                    if (altWithElse) {
                        currentY += 35;
                    }
                }

                // Calculate nesting levels
                const nestingLevels = new Map();
                [...parseData.loops, ...parseData.alts].forEach(structure => {
                    let level = 0;
                    [...parseData.loops, ...parseData.alts].forEach(other => {
                        if (other !== structure && 
                            other.startIndex < structure.startIndex && 
                            other.endIndex > structure.endIndex) {
                            level++;
                        }
                    });
                    nestingLevels.set(structure, level);
                });

                // Render loop boxes
                parseData.loops.forEach(loop => {
                    const startY = messagePositions.get(loop.startIndex) - 35;
                    const endY = messagePositions.get(loop.endIndex) + 25;
                    const nestLevel = nestingLevels.get(loop);
                    this.renderControlBox(startY, endY, positions, 'loop-box', nestLevel);
                });

                // Render alt boxes
                parseData.alts.forEach(alt => {
                    const startY = messagePositions.get(alt.startIndex) - 35;
                    const endY = messagePositions.get(alt.endIndex) + 25;
                    const nestLevel = nestingLevels.get(alt);
                    this.renderControlBox(startY, endY, positions, 'alt-box', nestLevel);
                });
            }

            renderControlBox(startY, endY, positions, className, nestLevel = 0) {
                const participantPositions = Array.from(positions.values());
                const indent = nestLevel * 8;
                const minX = Math.min(...participantPositions) - this.config.participantWidth / 2 - 20 + indent;
                const maxX = Math.max(...participantPositions) + this.config.participantWidth / 2 + 20 - indent;

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', minX);
                rect.setAttribute('y', startY);
                rect.setAttribute('width', maxX - minX);
                rect.setAttribute('height', endY - startY);
                rect.setAttribute('class', className);
                this.svg.appendChild(rect);
            }

            renderMessagesAndElements(parseData, positions, startY) {
                let currentY = startY;
                
                for (let i = 0; i < parseData.messages.length; i++) {
                    this.renderActivationsAtMessage(parseData.activations, positions, i, currentY);
                    
                    const notesAtThisIndex = parseData.notes.filter(note => note.messageIndex === i);
                    for (const note of notesAtThisIndex) {
                        currentY += 25;
                        this.renderNote(note, positions, currentY);
                        currentY += this.config.noteHeight + 25;
                    }

                    const loopAtThisIndex = parseData.loops.find(loop => loop.startIndex === i);
                    const altAtThisIndex = parseData.alts.find(alt => alt.startIndex === i);
                    
                    if (loopAtThisIndex) {
                        currentY += 35;
                        this.renderLoopStart(loopAtThisIndex, positions, currentY);
                        currentY += 35;
                    }
                    
                    if (altAtThisIndex) {
                        currentY += 35;
                        this.renderAltStart(altAtThisIndex, positions, currentY);
                        currentY += 35;
                    }

                    // Check if this is where an else should be rendered BEFORE the message
                    const altWithElse = parseData.alts.find(alt => 
                        alt.elseIndexes && alt.elseIndexes.some(elseData => elseData.index === i)
                    );
                    if (altWithElse) {
                        const elseData = altWithElse.elseIndexes.find(elseData => elseData.index === i);
                        this.renderAltElse(altWithElse, positions, currentY, elseData.condition);
                        currentY += 25;
                    }

                    this.renderMessage(parseData.messages[i], positions, currentY);
                    currentY += this.config.messageSpacing;

                    const loopEndAtThisIndex = parseData.loops.find(loop => loop.endIndex === i);
                    const altEndAtThisIndex = parseData.alts.find(alt => alt.endIndex === i);
                    
                    if (loopEndAtThisIndex || altEndAtThisIndex) {
                        currentY += 25;
                    }
                }

                return currentY;
            }

            renderMessage(message, positions, y) {
                const fromX = positions.get(message.from);
                const toX = positions.get(message.to);
                const markerUrl = message.isDashed ? 'url(#arrowhead-dashed)' : 'url(#arrowhead)';
                
                if (message.from === message.to) {
                    // Self message - draw a box
                    const boxWidth = 40;
                    const boxHeight = 20;
                    
                    // Right side of participant
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    const pathData = `M ${fromX} ${y} L ${fromX + boxWidth} ${y} L ${fromX + boxWidth} ${y + boxHeight} L ${fromX} ${y + boxHeight}`;
                    path.setAttribute('d', pathData);
                    path.setAttribute('fill', 'none');
                    path.setAttribute('marker-end', markerUrl);
                    
                    if (message.isDashed) {
                        path.setAttribute('class', 'message-line message-dashed message-return');
                    } else {
                        path.setAttribute('class', 'message-line');
                    }
                    
                    this.svg.appendChild(path);
                    
                    if (message.message) {
                        this.renderMessageText(message.message, fromX + boxWidth/2, fromX + boxWidth + 20, y + boxHeight/2);
                    }
                } else {
                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', fromX);
                    line.setAttribute('y1', y);
                    line.setAttribute('x2', toX);
                    line.setAttribute('y2', y);
                    line.setAttribute('marker-end', markerUrl);
                    
                    if (message.isDashed) {
                        line.setAttribute('class', 'message-line message-dashed message-return');
                    } else {
                        line.setAttribute('class', 'message-line');
                    }
                    
                    this.svg.appendChild(line);

                    if (message.message) {
                        this.renderMessageText(message.message, fromX, toX, y);
                    }
                }
            }

            renderMessageText(text, fromX, toX, y) {
                const bbox = this.getTextBoundingBox(text, 11);
                const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                bgRect.setAttribute('x', (fromX + toX) / 2 - bbox.width / 2 - 4);
                bgRect.setAttribute('y', y - 10 - bbox.height / 2 - 2);
                bgRect.setAttribute('width', bbox.width + 8);
                bgRect.setAttribute('height', bbox.height + 6);
                bgRect.setAttribute('class', 'message-bg');
                bgRect.setAttribute('rx', '4');
                this.svg.appendChild(bgRect);
                
                const textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                textElement.setAttribute('x', (fromX + toX) / 2);
                textElement.setAttribute('y', y - 10);
                textElement.setAttribute('class', 'message-text');
                textElement.textContent = text;
                this.svg.appendChild(textElement);
            }

            renderNote(note, positions, y) {
                const { x, width } = this.calculateNotePosition(note, positions);

                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', width);
                rect.setAttribute('height', this.config.noteHeight);
                rect.setAttribute('class', 'note');
                this.svg.appendChild(rect);

                this.renderWrappedText(note.text, x + width / 2, y + this.config.noteHeight / 2, width - 16, 'note-text', 'middle');
            }

            calculateNotePosition(note, positions) {
                let x, width;
                
                if (note.type === 'over') {
                    const firstParticipant = note.participants[0];
                    const lastParticipant = note.participants[note.participants.length - 1];
                    const startX = positions.get(firstParticipant);
                    const endX = positions.get(lastParticipant);
                    x = Math.min(startX, endX) - this.config.noteWidth / 2;
                    width = Math.abs(endX - startX) + this.config.noteWidth;
                } else {
                    const participantX = positions.get(note.participant);
                    width = this.config.noteWidth;
                    if (note.type === 'left') {
                        x = participantX - width - 25;
                    } else {
                        x = participantX + 25;
                    }
                }

                return { x, width };
            }

            renderWrappedText(text, x, y, maxWidth, className, anchor = 'middle') {
                const words = text.split(' ');
                const lines = [];
                let currentLine = '';
                
                for (const word of words) {
                    const testLine = currentLine ? `${currentLine} ${word}` : word;
                    if (testLine.length * 6 <= maxWidth) {
                        currentLine = testLine;
                    } else {
                        if (currentLine) lines.push(currentLine);
                        currentLine = word;
                    }
                }
                if (currentLine) lines.push(currentLine);

                const lineHeight = 14;
                const startY = y - (lines.length - 1) * lineHeight / 2;
                
                lines.forEach((line, index) => {
                    const textElement = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                    textElement.setAttribute('x', x);
                    textElement.setAttribute('y', startY + index * lineHeight);
                    textElement.setAttribute('class', className);
                    textElement.setAttribute('text-anchor', anchor);
                    textElement.textContent = line;
                    this.svg.appendChild(textElement);
                });
            }

            renderActivationsAtMessage(activations, positions, messageIndex, y) {
                activations.forEach((events, participant) => {
                    const participantX = positions.get(participant);
                    events.forEach(event => {
                        if (event.messageIndex === messageIndex) {
                            const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                            rect.setAttribute('x', participantX - this.config.activationWidth / 2);
                            rect.setAttribute('y', y - 12);
                            rect.setAttribute('width', this.config.activationWidth);
                            rect.setAttribute('height', 24);
                            rect.setAttribute('class', 'activation');
                            this.svg.appendChild(rect);
                        }
                    });
                });
            }

            renderLoopStart(loop, positions, y) {
                const labelText = `loop ${loop.condition}`;
                const textWidth = Math.max(100, labelText.length * 7 + 20);
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', this.config.margin);
                rect.setAttribute('y', y - 18);
                rect.setAttribute('width', textWidth);
                rect.setAttribute('height', 24);
                rect.setAttribute('class', 'loop-label');
                this.svg.appendChild(rect);

                this.renderWrappedText(labelText, this.config.margin + textWidth/2, y - 2, textWidth - 10, 'loop-text', 'middle');
            }

            renderAltStart(alt, positions, y) {
                const labelText = `alt ${alt.condition}`;
                const textWidth = Math.max(100, labelText.length * 7 + 20);
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', this.config.margin);
                rect.setAttribute('y', y - 18);
                rect.setAttribute('width', textWidth);
                rect.setAttribute('height', 24);
                rect.setAttribute('class', 'alt-label');
                this.svg.appendChild(rect);

                this.renderWrappedText(labelText, this.config.margin + textWidth/2, y - 2, textWidth - 10, 'alt-text', 'middle');
            }

            renderAltElse(alt, positions, y, elseCondition) {
                const participantPositions = Array.from(positions.values());
                const minX = Math.min(...participantPositions) - this.config.participantWidth / 2 - 20;
                const maxX = Math.max(...participantPositions) + this.config.participantWidth / 2 + 20;

                // Draw separator line
                const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                line.setAttribute('x1', minX);
                line.setAttribute('y1', y - 30);
                line.setAttribute('x2', maxX);
                line.setAttribute('y2', y - 30);
                line.setAttribute('stroke', '#94a3b8');
                line.setAttribute('stroke-width', '2');
                line.setAttribute('stroke-dasharray', '5,5');
                line.setAttribute('opacity', '0.8');
                this.svg.appendChild(line);

                const labelText = elseCondition ? `else ${elseCondition}` : 'else';
                const labelWidth = Math.max(100, labelText.length * 7 + 20);
                
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', this.config.margin);
                rect.setAttribute('y', y - 42);
                rect.setAttribute('width', labelWidth);
                rect.setAttribute('height', 24);
                rect.setAttribute('class', 'alt-label');
                this.svg.appendChild(rect);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', this.config.margin + labelWidth/2);
                text.setAttribute('y', y - 26);
                text.setAttribute('class', 'alt-text');
                text.setAttribute('text-anchor', 'middle');
                text.textContent = labelText;
                this.svg.appendChild(text);
            }

            getTextBoundingBox(text, fontSize) {
                return {
                    width: text.length * fontSize * 0.65,
                    height: fontSize
                };
            }

            updateSVGDimensions(participantCount, currentY) {
                const width = Math.max(900, this.config.margin * 2 + participantCount * this.config.participantSpacing);
                const height = Math.max(700, currentY + 120);
                this.svg.setAttribute('width', width);
                this.svg.setAttribute('height', height);
            }
        }

        // Export Functions
        function exportAs(format) {
            const svg = document.getElementById('diagram-svg');
            const svgData = new XMLSerializer().serializeToString(svg);
            
            switch(format) {
                case 'svg':
                    downloadFile(`data:image/svg+xml;charset=utf-8,${encodeURIComponent(svgData)}`, 'diagram.svg');
                    break;
                case 'png':
                    svgToPng(svgData);
                    break;
                case 'pdf':
                    alert('PDF export would be implemented with a library like jsPDF');
                    break;
            }
            
            document.getElementById('exportModal').style.display = 'none';
        }

        function svgToPng(svgData) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = function() {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.drawImage(img, 0, 0);
                
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    downloadFile(url, 'diagram.png');
                });
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(svgData);
        }

        function downloadFile(url, filename) {
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function copyToClipboard() {
            const svg = document.getElementById('diagram-svg');
            const svgData = new XMLSerializer().serializeToString(svg);
            
            navigator.clipboard.writeText(svgData).then(() => {
                alert('SVG code copied to clipboard!');
                document.getElementById('exportModal').style.display = 'none';
            });
        }



        // Main Application
        class SequenceDiagramEditor {
            constructor() {
                this.svgElement = document.getElementById('diagram-svg');
                this.codeEditor = document.getElementById('codeEditor');
                this.parser = new DiagramParser();
                this.renderer = new DiagramRenderer(this.svgElement);
                this.currentFile = null;
                this.currentVersion = null;
                
                this.init();
            }

            init() {
                this.codeEditor.addEventListener('input', () => this.updateDiagram());
                this.setupVersionControl();
                this.updateDiagram();
            }

            setupVersionControl() {
                const versionControl = document.getElementById('versionControl');
                versionControl.addEventListener('click', () => {
                    if (this.currentFile) {
                        window.modalManager.showVersionModal(this.currentFile);
                    }
                });
            }

            setCurrentFile(fileName, version) {
                this.currentFile = fileName;
                this.currentVersion = version;
                const versionControl = document.getElementById('versionControl');
                versionControl.textContent = `version: ${version}`;
                versionControl.style.display = 'block';
            }

            saveCurrentDiagram() {
                const content = this.codeEditor.value;
                const parseData = this.parser.parse(content);
                
                let fileName;
                if (this.currentFile) {
                    // If editing an existing file, save to the same file (new version)
                    fileName = this.currentFile;
                } else {
                    // Generate new filename
                    fileName = window.storageManager.generateFileName(parseData);
                }
                
                const result = window.storageManager.saveFile(fileName, content);
                this.setCurrentFile(result.name, result.version);
            }

            updateDiagram() {
                try {
                    const code = this.codeEditor.value;
                    const parseData = this.parser.parse(code);
                    this.renderer.render(parseData);
                } catch (error) {
                    console.error('Error rendering diagram:', error);
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            window.storageManager = new StorageManager();
            new ThemeManager();
            window.modalManager = new ModalManager();
            window.diagramEditor = new SequenceDiagramEditor();
        });
    </script>
</body>
</html>
